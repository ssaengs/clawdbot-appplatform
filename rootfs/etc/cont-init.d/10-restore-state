#!/command/with-contenv bash
# Restore state paths from restic backup

# Source s6 container environment (needed for cont-init scripts)
for f in /run/s6/container_environment/*; do
  [ -f "$f" ] && export "$(basename $f)"="$(cat $f)"
done

CONFIG_FILE="/etc/openclaw/backup.yaml"

# Ensure directories exist (only if variables are set)
[ -n "$openclaw_STATE_DIR" ] && mkdir -p "$openclaw_STATE_DIR"
[ -n "$openclaw_WORKSPACE_DIR" ] && mkdir -p "$openclaw_WORKSPACE_DIR"
[ -n "$TS_STATE_DIR" ] && mkdir -p "$TS_STATE_DIR"

# Check if persistence is configured
if [ -z "$RESTIC_REPOSITORY" ] || [ -z "$RESTIC_PASSWORD" ]; then
  echo "[restore-state] Persistence not configured, skipping"
  exit 0
fi

# Ensure AWS credentials are exported for restic S3 backend
if [ -z "$RESTIC_SPACES_ACCESS_KEY_ID" ] || [ -z "$RESTIC_SPACES_SECRET_ACCESS_KEY" ]; then
  echo "[restore-state] ERROR: RESTIC_SPACES_ACCESS_KEY_ID or RESTIC_SPACES_SECRET_ACCESS_KEY not set"
  exit 1
fi
export AWS_ACCESS_KEY_ID="$RESTIC_SPACES_ACCESS_KEY_ID" AWS_SECRET_ACCESS_KEY="$RESTIC_SPACES_SECRET_ACCESS_KEY"
export RESTIC_SPACES_ACCESS_KEY_ID RESTIC_SPACES_SECRET_ACCESS_KEY RESTIC_REPOSITORY RESTIC_PASSWORD

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
  echo "[restore-state] Config file not found: $CONFIG_FILE"
  exit 1
fi

# Check if repository has any snapshots
if ! restic snapshots --latest 1 2>/dev/null | grep -q 'ID'; then
  echo "[restore-state] No snapshots found in repository, skipping"
  exit 0
fi

# Restore all paths in order (config has /etc first)
PATH_COUNT=$(yq -r '.paths | length' "$CONFIG_FILE")

if [ "$PATH_COUNT" -eq 0 ]; then
  echo "[restore-state] No paths configured for restore"
  exit 0
fi

echo "[restore-state] Restoring $PATH_COUNT paths..."

for i in $(seq 0 $((PATH_COUNT - 1))); do
  RESTORE_PATH=$(yq -r ".paths[$i].path" "$CONFIG_FILE")

  # Ensure parent directory exists
  mkdir -p "$(dirname "$RESTORE_PATH")"

  # Find latest snapshot for this specific path
  SNAPSHOT_ID=$(restic snapshots --path "$RESTORE_PATH" --latest 1 --json 2>/dev/null | jq -r '.[0].id // empty')

  if [ -z "$SNAPSHOT_ID" ]; then
    echo "[restore-state] No snapshot found for $RESTORE_PATH, skipping"
    continue
  fi

  echo "[restore-state] Restoring: $RESTORE_PATH (snapshot $SNAPSHOT_ID)"

  # Run restic restore from the snapshot that contains this path
  if restic restore "$SNAPSHOT_ID" --target / --include "$RESTORE_PATH" 2>&1; then
    echo "[restore-state] Completed: $RESTORE_PATH"
  else
    echo "[restore-state] Warning: Restore may have had issues for $RESTORE_PATH (continuing)"
  fi
done

# Fix ownership on openclaw directories (restored as root, needs openclaw user)
if [ -n "$openclaw_STATE_DIR" ] && [ -d "$openclaw_STATE_DIR" ]; then
  chown -R openclaw:openclaw "$openclaw_STATE_DIR"
fi

# Fix ownership on tailscale directory
if [ -n "$TS_STATE_DIR" ] && [ -d "$TS_STATE_DIR" ]; then
  chown -R openclaw:openclaw "$TS_STATE_DIR"
  chmod 750 "$TS_STATE_DIR"
fi

echo "[restore-state] Restore complete"

#!/command/with-contenv bash
# Generate moltbot gateway configuration

set -e

# Validate mutual exclusivity of ngrok and tailscale
if [ "${ENABLE_NGROK:-false}" = "true" ] && [ "${ENABLE_TAILSCALE:-false}" = "true" ]; then
  echo "[generate-config] WARNING: Both ENABLE_NGROK and ENABLE_TAILSCALE are true."
  echo "[generate-config] This doesn't make sense - ngrok is public, Tailscale is private."
  echo "[generate-config] Defaulting to Tailscale (disable ENABLE_NGROK to silence this)."
fi

# Set HOME to moltbot's home so .profile uses correct paths
export HOME=/home/moltbot

# Source moltbot profile for PATH setup
. /home/moltbot/.profile

# Load nvm (needed for moltbot command)
export NVM_DIR="/home/moltbot/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
  echo "[generate-config] nvm loaded successfully"
else
  echo "[generate-config] ERROR: nvm.sh not found at $NVM_DIR/nvm.sh" >&2
  exit 1
fi

# Ensure state directory exists with correct ownership
mkdir -p "$MOLTBOT_STATE_DIR"
chown moltbot:moltbot "$MOLTBOT_STATE_DIR"

DEFAULT_CONFIG="/etc/moltbot/moltbot.default.json"
CONFIG_FILE="$MOLTBOT_STATE_DIR/moltbot.json"

echo "[generate-config] Building config: $CONFIG_FILE"

# Show version
echo "[generate-config] Checking moltbot installation..."
if ! command -v moltbot >/dev/null 2>&1; then
  echo "[generate-config] ERROR: moltbot command not found in PATH" >&2
  echo "[generate-config] PATH: $PATH" >&2
  echo "[generate-config] Node version: $(node --version 2>&1 || echo 'not found')" >&2
  exit 1
fi
echo "[generate-config] Moltbot version: $(moltbot --version 2>/dev/null || echo 'unknown')"

# Generate a gateway token if not provided
if [ -z "$MOLTBOT_GATEWAY_TOKEN" ]; then
  export MOLTBOT_GATEWAY_TOKEN=$(head -c 32 /dev/urandom | base64 | tr -d '=/+' | head -c 32)
  echo "[generate-config] Generated gateway token (ephemeral): $MOLTBOT_GATEWAY_TOKEN"
  echo "[generate-config] Save this token - you'll need it to connect to the Control UI"
fi

# Write token to s6 environment (both MOLTBOT_ and CLAWDBOT_ for compatibility)
mkdir -p /run/s6/container_environment
echo "$MOLTBOT_GATEWAY_TOKEN" > /run/s6/container_environment/MOLTBOT_GATEWAY_TOKEN
echo "$MOLTBOT_GATEWAY_TOKEN" > /run/s6/container_environment/CLAWDBOT_GATEWAY_TOKEN
echo "[generate-config] Gateway token configured (CLAWDBOT_GATEWAY_TOKEN)"

# Start with default config as base
if [ -f "$DEFAULT_CONFIG" ]; then
  cp "$DEFAULT_CONFIG" "$CONFIG_FILE"
  echo "[generate-config] Using default config from $DEFAULT_CONFIG"
else
  # Fallback minimal config if default doesn't exist
  echo '{"gateway": {"mode": "local"}}' > "$CONFIG_FILE"
  echo "[generate-config] Warning: Default config not found, using minimal config"
fi

# Add Gradient AI provider if API key is set
if [ -n "$GRADIENT_API_KEY" ]; then
  echo "[generate-config] Adding Gradient AI provider to config"

  # Build Gradient provider config with full model definitions
  GRADIENT_CONFIG=$(cat <<EOF
{
  "models": {
    "mode": "merge",
    "providers": {
      "gradient": {
        "baseUrl": "https://inference.do-ai.run/v1",
        "apiKey": "$GRADIENT_API_KEY",
        "api": "openai-completions",
        "models": [
          {
            "id": "llama3.3-70b-instruct",
            "name": "Llama 3.3 70B Instruct",
            "reasoning": false,
            "input": ["text"],
            "contextWindow": 128000,
            "maxTokens": 8192
          },
          {
            "id": "deepseek-r1-distill-llama-70b",
            "name": "DeepSeek R1 Distill Llama 70B",
            "reasoning": true,
            "input": ["text"],
            "contextWindow": 128000,
            "maxTokens": 8192
          },
          {
            "id": "openai-gpt-oss-120b",
            "name": "OpenAI GPT OSS 120B",
            "reasoning": false,
            "input": ["text"],
            "contextWindow": 128000,
            "maxTokens": 8192
          }
        ]
      }
    }
  },
  "agents": {
    "defaults": {
      "model": {
        "primary": "gradient/openai-gpt-oss-120b"
      }
    }
  }
}
EOF
)

  # Merge Gradient config into main config
  jq --argjson gradient "$GRADIENT_CONFIG" '. * $gradient' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
fi

# Handle ENABLE_UI flag - disable Control UI if set to false
if [ "${ENABLE_UI:-true}" = "false" ]; then
  echo "[generate-config] Disabling Control UI (ENABLE_UI=false)"
  jq '.gateway.controlUi.enabled = false' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
fi

# Add Tailscale config when enabled
if [ "${ENABLE_TAILSCALE:-false}" = "true" ]; then
  echo "[generate-config] Adding Tailscale serve config"
  jq '.gateway.tailscale.resetOnExit = true | .gateway.tailscale.mode = "serve" | .gateway.auth.allowTailscale = true' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
fi

# Add gateway auth token to config
echo "[generate-config] Adding gateway.auth.token to config"
jq --arg token "$MOLTBOT_GATEWAY_TOKEN" '.gateway.auth.token = $token | .gateway.auth.mode = "token"' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

# Ensure moltbot owns all state files
chown -R moltbot:moltbot "$MOLTBOT_STATE_DIR"

echo "[generate-config] Final config:"
jq '.' "$CONFIG_FILE"
